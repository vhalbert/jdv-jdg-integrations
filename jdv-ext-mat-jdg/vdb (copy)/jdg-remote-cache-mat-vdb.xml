<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<vdb name="StockMat" version="1">

    <description>Shows how to materialize into an Infinispan remote cache</description>
    
    <property name="UseConnectorMetadata" value="cached" />   
    
    <import-vdb name="Portfolio" version="1" import-data-policies="true"/>
    
    <model name="StockJDGSource" type="Physical">
        <property name="importer.useFullSchemaName" value="false"/>
           
        <source name="StockJDGSource" translator-name="infinispan1" connection-jndi-name="java:/infinispanStocks" />
    </model>      
    
        <model name="StocksMatView" type="VIRTUAL">
                <property name="imports" value="StockJDGSource"/>
                <metadata type="DDL"><![CDATA[
CREATE VIEW Stock (
	product_id integer OPTIONS(NAMEINSOURCE '"product_id"', NATIVE_TYPE 'integer', UPDATABLE 'FALSE', FIXED_LENGTH 'TRUE'),
	symbol string(4000) OPTIONS(NAMEINSOURCE '"symbol"', NATIVE_TYPE 'string', UPDATABLE 'FALSE'),
	price string(50) OPTIONS(NAMEINSOURCE '"price"', NATIVE_TYPE 'String', UPDATABLE 'FALSE', SIGNED 'FALSE', FIXED_LENGTH 'TRUE'),
	company_name string(256) OPTIONS(NAMEINSOURCE '"company_name"', NATIVE_TYPE 'string', UPDATABLE 'FALSE'),
	CONSTRAINT PK_prodid PRIMARY KEY(product_id)
) OPTIONS(MATERIALIZED 'TRUE', MATERIALIZED_TABLE 'StockJDGSource.Stock', 
"teiid_rel:ALLOW_MATVIEW_MANAGEMENT" 'TRUE', 
"teiid_rel:MATVIEW_AFTER_LOAD_SCRIPT" 'execute StockJDGSource.native(''swap cache names'');', 
"teiid_rel:MATVIEW_STATUS_TABLE" 'Accounts.status', "teiid_rel:MATVIEW_TTL" '1000', 
"teiid_rel:MATVIEW_BEFORE_LOAD_SCRIPT" 'execute StockJDGSource.native(''truncate cache'');', 
"teiid_rel:MATERIALIZED_STAGE_TABLE" 'StockJDGSource.ST_Stock') 
AS
	SELECT
		Stocks.Stock.product_id, Stocks.Stock.symbol, CAST(Stocks.Stock.price AS String) AS price, Stocks.Stock.company_name
	FROM
		Stocks.Stock;

        ]]></metadata>
        </model>
         
  
    <translator name="infinispan1" type="ispn-hotrod">

       <property name="SupportsDirectQueryProcedure" value="true"/>
       <property name="SupportsNativeQueries" value="true"/>
        <property name="SupportsCompareCriteriaOrdered" value="true" />

    </translator>
</vdb>
